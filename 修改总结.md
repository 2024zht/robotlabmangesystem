# 积分系统问题修复总结

本文档总结了针对积分管理系统的五个问题的修复方案。

## 问题列表

1. ✅ 批量导入模板是乱码
2. ✅ 积分修改显示的时间是错误的
3. ✅ A可以查看B的积分历史
4. ✅ 设置单次添加积分上限（200）
5. ✅ 如何修改数据库中某个人的积分

---

## 1. 修复批量导入CSV模板乱码问题

### 问题描述
下载的CSV模板在Excel中打开时出现中文乱码。

### 原因分析
CSV文件缺少UTF-8 BOM（Byte Order Mark），导致Excel无法正确识别UTF-8编码。

### 解决方案
在生成CSV文件时添加UTF-8 BOM标记。

### 修改文件
- `frontend/src/components/Admin.tsx`

### 修改内容
```typescript
const downloadTemplate = () => {
  const template = `学号,积分,备注
2021001,10,完成实验报告
2021002,15,参加组会并发言
2021003,-5,迟到`;
  
  // 添加 UTF-8 BOM 来防止乱码
  const BOM = '\uFEFF';
  const blob = new Blob([BOM + template], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = '批量导入模板.csv';
  link.click();
};
```

### 测试方法
1. 在管理员面板中点击"下载模板文件"
2. 用Excel打开下载的CSV文件
3. 确认中文显示正常

---

## 2. 修复积分修改时间显示错误

### 问题描述
积分变更历史中显示的时间格式不正确或时区有偏差。

### 原因分析
使用`toLocaleString('zh-CN')`时未指定详细的格式选项，可能导致格式不一致或时区问题。

### 解决方案
在所有时间显示处添加详细的格式化选项，确保统一的日期时间格式。

### 修改文件
- `frontend/src/components/Dashboard.tsx`

### 修改内容
将所有的时间显示从：
```typescript
{new Date(log.createdAt).toLocaleString('zh-CN')}
```

修改为：
```typescript
{new Date(log.createdAt).toLocaleString('zh-CN', {
  year: 'numeric',
  month: '2-digit',
  day: '2-digit',
  hour: '2-digit',
  minute: '2-digit',
  second: '2-digit',
  hour12: false
})}
```

### 测试方法
1. 查看任意用户的积分历史
2. 确认时间显示格式为：YYYY/MM/DD HH:mm:ss（24小时制）

---

## 3. 修复权限问题 - 禁止用户查看他人积分历史

### 问题描述
普通用户可以点击任意其他用户的行查看其积分历史，存在隐私问题。

### 原因分析
在点击行时没有进行权限验证，任何用户都可以查看他人的积分记录。

### 解决方案
在`handleRowClick`函数中添加权限检查，只允许管理员或用户本人查看积分历史。

### 修改文件
- `frontend/src/components/Dashboard.tsx`

### 修改内容
```typescript
const handleRowClick = async (user: User, e: React.MouseEvent) => {
  // 如果点击的是按钮，不触发行点击
  if ((e.target as HTMLElement).closest('button')) {
    return;
  }

  // 权限检查：只有管理员或本人可以查看积分历史
  if (!currentUser?.isAdmin && currentUser?.id !== user.id) {
    alert('您只能查看自己的积分历史');
    return;
  }

  // ... 原有代码
};
```

### 测试方法
1. 以普通用户身份登录
2. 尝试点击其他用户的行
3. 应该显示"您只能查看自己的积分历史"提示
4. 点击自己的行应该能正常查看
5. 以管理员身份登录，应该能查看所有人的积分历史

---

## 4. 添加单次积分修改上限验证（200分）

### 问题描述
管理员修改积分时没有上限限制，可能导致误操作或滥用。

### 原因分析
系统未设置单次积分修改的范围限制。

### 解决方案
在前端和后端都添加验证，限制单次积分修改范围为 -200 到 +200。

### 修改文件
- `frontend/src/components/Dashboard.tsx`（前端验证）
- `backend/src/routes/users.ts`（后端验证）

### 前端修改内容

#### 1. 在handleApplyRule函数中添加验证：
```typescript
const handleApplyRule = async () => {
  // ... 原有代码 ...

  // 验证单次积分修改不超过200分（正负）
  if (Math.abs(points) > 200) {
    alert('单次积分修改不能超过200分（加分或扣分）');
    return;
  }

  // ... 原有代码 ...
};
```

#### 2. 在自定义积分输入框添加提示和限制：
```typescript
<input
  type="number"
  value={customPoints}
  onChange={(e) => {
    setCustomPoints(e.target.value);
    setSelectedRule(null);
  }}
  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
  placeholder="例如: 10 或 -5"
  min="-200"
  max="200"
/>
<p className="text-xs text-gray-500 mt-1">⚠️ 单次积分修改范围：-200 ~ +200</p>
```

### 后端修改内容

在`users.ts`的积分修改路由中添加验证：
```typescript
router.patch('/:id/points', authenticateToken, requireAdmin, async (req: AuthRequest, res: Response) => {
  const userId = parseInt(req.params.id);
  const { points, reason } = req.body;

  if (typeof points !== 'number') {
    return res.status(400).json({ error: '积分必须是数字' });
  }

  // 验证单次积分修改不超过200分（正负）
  if (Math.abs(points) > 200) {
    return res.status(400).json({ error: '单次积分修改不能超过200分（加分或扣分）' });
  }

  // ... 原有代码 ...
});
```

### 测试方法
1. 尝试修改积分超过 200 分（例如输入 250）
2. 应该显示错误提示："单次积分修改不能超过200分（加分或扣分）"
3. 尝试扣分超过 200 分（例如输入 -250）
4. 应该显示同样的错误提示
5. 输入 -200 到 200 之间的值应该能正常修改

---

## 5. 如何修改数据库中某个人的积分

### 问题描述
需要直接通过数据库命令修改用户积分的方法。

### 解决方案
创建了详细的数据库操作文档：`如何直接修改数据库积分.md`

### 文档内容概要

#### 基本操作
1. **连接数据库**
   ```bash
   cd backend
   sqlite3 database.sqlite
   ```

2. **查看所有用户**
   ```sql
   SELECT id, username, name, studentId, points FROM users;
   ```

3. **修改积分（按学号）**
   ```sql
   -- 直接设置积分值
   UPDATE users SET points = 100 WHERE studentId = '2021001';
   
   -- 增加积分
   UPDATE users SET points = points + 10 WHERE studentId = '2021001';
   
   -- 减少积分
   UPDATE users SET points = points - 5 WHERE studentId = '2021001';
   ```

#### 推荐的完整操作（含日志记录）
```sql
BEGIN TRANSACTION;

-- 修改积分
UPDATE users SET points = points + 10 WHERE studentId = '2021001';

-- 添加日志
INSERT INTO point_logs (userId, points, reason, createdBy, createdAt)
SELECT 
    u.id,
    10,
    '数据库直接修改',
    (SELECT id FROM users WHERE isAdmin = 1 LIMIT 1),
    datetime('now', 'localtime')
FROM users u 
WHERE u.studentId = '2021001';

COMMIT;
```

#### 批量操作
```sql
BEGIN TRANSACTION;

-- 批量修改
UPDATE users SET points = points + 10 
WHERE studentId IN ('2021001', '2021002', '2021003');

-- 批量添加日志
INSERT INTO point_logs (userId, points, reason, createdBy, createdAt)
SELECT 
    u.id,
    10,
    '批量数据库调整',
    (SELECT id FROM users WHERE isAdmin = 1 LIMIT 1),
    datetime('now', 'localtime')
FROM users u 
WHERE studentId IN ('2021001', '2021002', '2021003');

COMMIT;
```

#### 常用查询
- 查看积分排名
- 查看用户积分历史
- 按年级/班级批量修改
- 重置用户积分

详细内容请参考：`如何直接修改数据库积分.md`

---

## 注意事项

### 部署更新
修改完成后需要：

1. **重新编译前端**
   ```bash
   cd frontend
   npm run build
   ```

2. **重新编译后端**（如果使用TypeScript）
   ```bash
   cd backend
   npm run build
   ```

3. **重启服务**
   ```bash
   # 停止当前服务
   # 启动新服务
   cd backend
   npm start
   ```

### 数据库备份
在进行数据库直接操作前，务必备份：
```bash
cp backend/database.sqlite backend/database.sqlite.backup
```

### 测试建议
1. 在开发环境中充分测试所有修改
2. 测试各种边界情况（如正好200分、-200分）
3. 测试不同角色的权限（管理员、普通用户）
4. 验证时间显示在不同浏览器中的表现

---

## 技术栈
- **前端**: React + TypeScript
- **后端**: Node.js + Express + TypeScript
- **数据库**: SQLite

## 相关文件
- `frontend/src/components/Admin.tsx` - 管理员面板
- `frontend/src/components/Dashboard.tsx` - 积分排行榜
- `backend/src/routes/users.ts` - 用户相关API
- `如何直接修改数据库积分.md` - 数据库操作指南

---

*修改完成时间：2024年*
*所有修改已通过Lint检查*

