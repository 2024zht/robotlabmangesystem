# 实验室成员/外部访客功能说明

## 功能概述

系统现在支持两种用户类型：
1. **实验室成员**：拥有完整的系统访问权限
2. **外部访客**：仅能浏览设备借用信息，不能申请借用

## 功能特性

### 注册时选择身份

在注册页面新增了"身份类型"选项：
- 实验室成员（默认）
- 外部访客（仅浏览设备）

### 实验室成员权限

实验室成员可以访问所有功能：
- 积分看板
- 规则展示
- 请假申请
- 点名签到
- 设备借用（可申请）
- 电子书库
- 管理面板（仅管理员）

### 外部访客权限

外部访客仅能：
- 浏览设备类型和实例
- 查看设备可用情况
- **可以申请借用设备**
- 查看自己的借用申请记录
- **不能访问其他功能模块**（积分、规则、请假、点名、电子书等）

### 界面标识

- 外部访客在用户信息旁会显示"(访客)"标识
- 不显示积分信息
- 设备列表中可以正常"申请借用"
- 页面顶部显示蓝色提示框说明访客身份和权限

## 数据库变更

### 迁移脚本

1. `backend/src/database/migrate-add-member.ts` - 添加isMember字段
2. `backend/src/database/set-all-members.ts` - 将现有用户设置为实验室成员

### 字段说明

在`users`表中新增字段：
- `isMember` (INTEGER): 1=实验室成员, 0=外部访客，默认值为1

## 代码变更

### 后端变更

1. **类型定义** (`backend/src/types/index.ts`)
   - User接口添加isMember字段

2. **注册路由** (`backend/src/routes/auth.ts`)
   - 注册时接收isMember参数
   - 登录时返回isMember信息

3. **用户路由** (`backend/src/routes/users.ts`)
   - 查询用户时包含isMember字段

### 前端变更

1. **类型定义** (`frontend/src/types/index.ts`)
   - User接口添加isMember字段

2. **注册页面** (`frontend/src/components/Register.tsx`)
   - 添加身份类型选择下拉框
   - 提交时传递isMember参数

3. **设备借用页面** (`frontend/src/components/Equipment.tsx`)
   - 显示访客权限提示
   - 禁用非成员的借用申请功能
   - 显示"仅浏览"标签

4. **布局组件** (`frontend/src/components/Layout.tsx`)
   - 根据isMember控制导航菜单显示
   - 显示访客身份标识
   - 非成员不显示积分信息

5. **路由配置** (`frontend/src/App.tsx`)
   - 添加MemberRoute守卫
   - 非成员访问受限页面时重定向到设备借用
   - 非成员登录后直接进入设备借用页面

6. **认证上下文** (`frontend/src/contexts/AuthContext.tsx`)
   - register函数添加isMember参数

7. **API服务** (`frontend/src/services/api.ts`)
   - authAPI.register添加isMember参数

## 使用说明

### 创建外部访客账户

1. 访问注册页面
2. 填写基本信息
3. 在"身份类型"中选择"外部访客（仅浏览设备）"
4. 完成注册

### 查看效果

- 使用外部访客账户登录
- 自动进入设备借用页面
- 导航栏仅显示"设备借用"选项
- 用户名旁显示"(访客)"标识
- 设备列表中无法点击"申请借用"

## 管理员说明

- 所有现有用户自动设置为实验室成员
- 管理员账户始终是实验室成员
- 管理员可以在管理面板查看所有用户的成员状态

## 技术细节

### 权限控制层级

1. **数据库层**：通过isMember字段存储用户类型
2. **后端路由层**：验证用户身份并返回相应数据
3. **前端路由层**：使用MemberRoute守卫限制页面访问
4. **前端UI层**：根据user.isMember动态显示/隐藏功能

### 安全考虑

- 后端会验证用户的isMember状态
- 即使前端绕过，后端仍会拒绝非成员的借用申请
- JWT令牌中不包含isMember，避免令牌篡改风险
- 每次请求都从数据库查询最新权限状态

## 未来扩展

可能的扩展方向：
1. 允许管理员在管理面板中修改用户的成员状态
2. 添加成员申请流程（访客申请成为成员）
3. 为不同成员等级设置不同权限
4. 记录访客的浏览行为

