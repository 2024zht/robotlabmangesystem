# 数据库迁移说明

## 需要运行的迁移脚本

由于添加了新功能，需要运行以下迁移脚本来更新数据库结构：

### 1. 添加书籍分类功能

```bash
cd backend
npx ts-node src/database/migrate-add-ebook-category.ts
```

这个脚本会：
- 创建 `ebook_categories` 表（书籍分类表）
- 为 `ebooks` 表添加 `categoryId` 字段
- 创建默认分类（未分类、编程语言、机器人学、人工智能等）
- 将所有现有书籍设置为"未分类"

### 2. 添加超级管理员功能

```bash
cd backend
npx ts-node src/database/migrate-add-superadmin.ts
```

这个脚本会：
- 为 `users` 表添加 `isSuperAdmin` 字段
- **自动将第一个管理员（admin账户）设置为超级管理员**

## 快速执行（在项目根目录运行）

```bash
# 方式1：分别运行
cd backend
npx ts-node src/database/migrate-add-ebook-category.ts
npx ts-node src/database/migrate-add-superadmin.ts

# 方式2：一行命令运行两个脚本
cd backend && npx ts-node src/database/migrate-add-ebook-category.ts && npx ts-node src/database/migrate-add-superadmin.ts
```

## 运行后重启服务器

迁移完成后，重启后端服务器即可生效：

```bash
# 如果使用 npm run dev
# 按 Ctrl+C 停止，然后重新运行：
npm run dev
```

## 验证迁移是否成功

### 1. 检查书籍分类
- 登录管理员账户
- 进入电子书库页面
- 应该能看到"分类管理"按钮
- 点击应该能看到默认分类列表

### 2. 检查超级管理员
- 登录 admin 账户
- 进入管理面板 > 用户管理
- admin 账户应该显示为"超级管理员"（渐变色徽章）
- 可以修改其他管理员的权限和积分

## 新功能说明

### 📚 书籍分类功能
1. **分类管理**：管理员可以创建、编辑、删除书籍分类
2. **书籍分类**：上传书籍后，可以为每本书选择分类
3. **分类筛选**：用户可以按分类筛选书籍
4. **自动提醒**：已有书籍会显示为"未分类"，提示管理员进行重新分类

### 👑 超级管理员功能
1. **权限分级**：
   - 超级管理员：拥有所有权限
   - 普通管理员：不能修改其他管理员的权限和积分
   
2. **权限保护**：
   - 普通管理员之间无法互相修改权限和积分
   - 只有超级管理员可以设置或取消管理员权限
   - 不能移除超级管理员的管理员权限

3. **界面显示**：
   - 超级管理员：渐变色徽章（紫色到粉色）
   - 普通管理员：紫色徽章
   - 普通成员：灰色徽章

### 🕐 时间显示修复
- 所有时间记录现在都使用北京时间（东八区）
- 不再显示UTC时间（慢8小时的问题已修复）

### 👤 用户管理优化
- 用户管理界面现在显示用户的真实姓名
- 用户名作为副标题显示在下方

## 注意事项

⚠️ **重要**：
1. 迁移脚本是**安全的**，不会删除任何现有数据
2. 第一个管理员（通常是 admin）会自动成为超级管理员
3. 已有书籍会被标记为"未分类"，需要管理员手动分类
4. 迁移完成后必须重启服务器才能生效

